{% extends "unicat/layout.html" %}
{% load static %}

{% block title %}
    {{ resource.document.name|cut:"resources/" }} - Unicat Resources
{% endblock %}

{% block body %}
<div class="container resource-detail-container">
    <div class="row mb-4">
        <div class="col-md-12">
            
            
            <div class="card resource-detail-card">
                
                <div class="card-header d-flex align-items-center justify-content-between position-relative">
                    <div class="d-flex align-items-center">
                        <h2 class="mb-0 me-2">{{ resource.document.name|cut:"resources/" }}</h2>
                        <a href="{% url 'resources' %}" class="btn btn-outline-primary ms-2 back-to-resources">
                            <i class="bi bi-arrow-left"></i> Back to Resources
                        </a>
                    </div>
                    
                    <div class="position-absolute" style="top: 10px; right: 15px;">
                        <div class="badges-container">
                            <span class="badge bg-secondary field_of_study">{{ resource.field_of_study }}</span>
                            <span class="badge bg-info resource_type me-2" style="padding-bottom:7px">{{ resource.type }}</span>
                        </div>
                    </div>
                    
                    <!--  Botones de acción (derecha) -->
                    <div class="d-flex align-items-center mt-4">
                        <div class="d-flex resource-detail-buttons-div">
                            {% if resource.document %}
                                <a href="{{ resource.document.url }}" class="btn btn-success action-btn resource-detail-buttons" target="_blank">
                                    <i class="fas fa-download"></i> Download
                                </a>
                            {% endif %}
                            {% if resource.user == user %}
                                <button class="btn btn-warning action-btn edit-resource-btn resource-detail-buttons" 
                                        data-resource-id="{{ resource.id }}" 
                                        data-description="{{ resource.description }}" 
                                        data-type="{{ resource.type }}"
                                        data-field-study="{{ resource.field_of_study }}"
                                        data-bs-toggle="modal"
                                        data-bs-target="#editResourceModal">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-danger action-btn delete-resource-btn resource-detail-buttons" 
                                        data-resource-id="{{ resource.id }}"
                                        data-resource-name="{{ resource.document.name|cut:'resources/'|truncatechars:30 }}"
                                        data-detail-page="true">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="card-body" >
                    <div class="resource-meta mb-3" >
                        <div class="row" >
                            <div class="col-md-6">
                                <p><strong>Shared by:</strong> {{ resource.user.username }}</p>
                                <p style="width: 300px;"><strong>Date:</strong> {{ resource.timestamp|date:"d M, Y" }}</p>
                                {% if resource.updated_at %}<p style="width: 300px;"><strong>Last edit:</strong> {{ resource.updated_at|date:"d M, Y" }}</p>{% endif %}
                        </div>
                        
                    </div>
                </div>
                    
                    <h4>Description</h4>
                    <div class="resource-description mb-4">
                        {{ resource.description|linebreaks }}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h3>Discussion</h3>
                </div>
                <div class="card-body ">
                    <!-- Add a new comment form -->
                    <form method="post" action="{% url 'add_comment' resource.id %}">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="comment" class="form-label">Add a comment or question</label>
                            <textarea class="form-control" id="comment" name="text" rows="5" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Post Comment</button>
                    </form>
                    
                    <hr>
                    
                    <div class="comments-list mt-4">
                        <h4>{{ total_comments }} comment{{ total_comments|pluralize }}</h4>
                        
                        {% if comments %}
                        <div class="comments-container">
                            {% for comment in comments %}
                            <div class="comment-item mb-4" id="comment-{{ comment.id }}">
                                <div class="d-flex">
                                    <div class="comment-avatar me-3">
                                        {% if comment.user.profile.profile_picture %}
                                            <img src="{{ comment.user.profile.profile_picture.url }}" alt="{{ comment.user.username }}" class="rounded-circle" width="55" height="50" style="padding-left: 5px;">
                                        {% else %}
                                            <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                                                {{ comment.user.username|make_list|first|upper }}
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="comment-content flex-grow-1">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <!-- Fixed the template syntax error -->
                                            {% if comment.user.username == username %}
                                                <h6 class="mb-0">{{ comment.user.get_full_name|default:comment.user.username }}</h6>
                                            {% else %}
                                                <h6 class="mb-0">
                                                    <a href="{% url 'user_profile' comment.user.username %}" class="text-decoration-none">
                                                        {{ comment.user.get_full_name|default:comment.user.username }}
                                                    </a>
                                                </h6>
                                            {% endif %}
                                            <div class="comment-dates text-end">
                                                <small class="text-muted text-nowrap d-block">{{ comment.created_at|date:"d/m/Y H:i" }}</small>
                                                {% if comment.edit_display %}
                                                    <small class="text-nowrap d-block resources-comment-update">
                                                        {{ comment.edit_display }}
                                                    </small>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="comment-text mt-2">
                                            {{ comment.text|linebreaks }}
                                        </div>
                                        <div class="comment-actions mt-2 d-flex align-items-center">
                                            <button class="btn btn-sm btn-light reply-toggle me-2" data-comment-id="{{ comment.id }}">
                                                <i class="fas fa-reply me-1"></i> Reply
                                            </button>
                                            
                                            {% if comment.user == user %}
                                            <div class="comment-owner-actions">
                                                <button class="btn btn-sm btn-outline-primary edit-comment-btn me-1" 
                                                        data-comment-id="{{ comment.id }}" 
                                                        data-comment-text="{{ comment.text }}">
                                                    <i class="fas fa-edit me"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger delete-comment-btn" 
                                                        data-comment-id="{{ comment.id }}"
                                                        data-comment-type="comment">
                                                    <i class="fas fa-trash me"></i>
                                                </button>
                                            </div>
                                            {% endif %}
                                        </div>
                                        
                                        <!-- Reply form (hidden by default) -->
                                        <div class="reply-form mt-3" id="reply-form-{{ comment.id }}" style="display: none;">
                                            <form method="post" action="{% url 'add_comment' resource.id %}">
                                                {% csrf_token %}
                                                <input type="hidden" name="parent_id" value="{{ comment.id }}">
                                                <div class="mb-2">
                                                    <textarea class="form-control" name="text" rows="3" placeholder="Write your reply..." required></textarea>
                                                </div>
                                                <div class="d-flex justify-content-end">
                                                    <button type="button" class="btn btn-sm btn-outline-secondary cancel-reply" data-comment-id="{{ comment.id }}">Cancel</button>
                                                    <button type="submit" class="btn btn-sm btn-primary">Reply</button>
                                                </div>
                                            </form>
                                        </div>
                                        
                                        <!-- Replies section -->
                                        {% if comment.replies.all %}
                                        <div class="replies mt-3">
                                            <div class="ps-3 border-start">
                                                {% for reply in comment.replies.all %}
                                                <div class="reply-item mb-3" id="reply-{{ reply.id }}">
                                                    <div class="d-flex">
                                                        <div class="reply-avatar me-2">
                                                            {% if reply.user.profile.profile_picture %}
                                                                <img src="{{ reply.user.profile.profile_picture.url }}" alt="{{ reply.user.username }}" class="rounded-circle" width="35" height="35">
                                                            {% else %}
                                                                <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center" style="width: 35px; height: 35px;">
                                                                    {{ reply.user.username|make_list|first|upper }}
                                                                </div>
                                                            {% endif %}
                                                        </div>
                                                        <div class="reply-content flex-grow-1">
                                                            <div class="d-flex justify-content-between align-items-start">
                                                                <!--  Fixed the template syntax for replies too -->
                                                                {% if reply.user.username == username %}
                                                                    <h6 class="mb-0 fs-6">{{ reply.user.get_full_name|default:reply.user.username }}</h6>
                                                                {% else %}
                                                                    <h6 class="mb-0 fs-6"><a class="text-decoration-none" href="{% url 'user_profile' reply.user.username %}">{{ reply.user.get_full_name|default:reply.user.username }}</a></h6>
                                                                {% endif %}
                                                                <div class="reply-dates text-end">
                                                                    <small class="text-muted d-block">{{ reply.created_at|date:"d/m/Y H:i" }}</small>
                                                                    {% if reply.edit_display %}
                                                                        <small class="d-block resources-comment-update">
                                                                            {{ reply.edit_display }}
                                                                        </small>
                                                                    {% endif %}
                                                                </div>
                                                            </div>
                                                            <div class="reply-text mt-1">
                                                                {{ reply.text|linebreaks }}
                                                            </div>
                                                            
                                                            {% if reply.user == user %}
                                                            <div class="reply-actions mt-2 d-flex justify-content-end">
                                                                <button class="btn btn-sm btn-outline-primary edit-reply-btn me-1" 
                                                                        data-reply-id="{{ reply.id }}" 
                                                                        data-reply-text="{{ reply.text }}">
                                                                    <i class="fas fa-edit me"></i>
                                                                </button>
                                                                <button class="btn btn-sm btn-outline-danger delete-comment-btn" 
                                                                        data-comment-id="{{ reply.id }}"
                                                                        data-comment-type="reply">
                                                                    <i class="fas fa-trash me"></i>
                                                                </button>
                                                            </div>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <hr>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-4 text-muted">
                            <i class="fas fa-comments fa-2x mb-2"></i>
                            <p>No comments yet. Be the first to start the discussion!</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editResourceModal" tabindex="-1" aria-labelledby="editResourceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editResourceModalLabel">Edit Resource</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editResourceForm" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <input type="hidden" id="edit-resource-id" name="resource_id">
                    
                    <div class="mb-3">
                        <label for="edit-document" class="form-label">File</label>
                        <input type="file" class="form-control" id="edit-document" name="document">
                        <small class="form-text text-muted">Leave empty to keep current file.</small>
                    </div>
                    
                    <!--  Checkbox per eliminar el fitxer actual -->
                    <div class="mb-3" id="current-file-section" style="display: none;">
                        <div class="d-flex align-items-center gap-3">
                            <div class="alert alert-info d-inline-flex align-items-center mb-0 px-3 py-2">
                                <i class="fas fa-file me-2"></i>
                                <span><strong>Current file:</strong> <span id="current-file-name">No file</span></span>
                            </div>
                            <div class="form-check mb-0">
                                <input class="form-check-input" type="checkbox" id="delete-current-file" name="delete_current_file" value="true">
                                <label class="form-check-label text-danger" for="delete-current-file">
                                    <i class="fas fa-trash me-1"></i>
                                    Delete current file
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit-description" class="form-label">Description <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="edit-description" name="description" rows="10" required></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit-field-study" class="form-label">Field of Study <span class="text-danger">*</span></label>
                        <select class="form-control" id="edit-field-study" name="field_study" required>
                            {% for field in fields_of_study %}
                                <option value="{{ field }}" {% if field == resource.field_of_study %}selected{% endif %}>{{ field }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit-category" class="form-label">Category <span class="text-danger">*</span></label>
                        <select class="form-control" id="edit-category" name="category" required>
                            {% for choice in categories %}
                                <option value="{{ choice.0 }}">{{ choice.1 }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary cancel-modal" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteResourceModal" tabindex="-1" aria-labelledby="deleteResourceModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteResourceModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete "<span id="delete-resource-name"></span>"?</p>
                <p class="text-danger">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary cancel-modal" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger delete-resource-detail" id="confirm-delete-btn">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal d'edició de comentaris -->
<div class="modal fade" id="editCommentModal" tabindex="-1" aria-labelledby="editCommentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editCommentModalLabel"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editCommentForm" method="post" action="">
                {% csrf_token %}
                <div class="modal-body">
                    <input type="hidden" id="edit-comment-id" name="comment_id">
                    <input type="hidden" name="action" value="edit">
                    <div class="mb-3">
                        <label for="edit-comment-text" class="form-label">Comment text</label>
                        <textarea class="form-control" id="edit-comment-text" name="text" rows="15" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary cancel-modal" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button> 
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal d'eliminació de comentaris -->
<div class="modal fade" id="deleteCommentModal" tabindex="-1" aria-labelledby="deleteCommentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteCommentModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this <span id="comment-type-text">comment</span>?</p>
                <p class="text-danger">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary cancel-modal" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteCommentForm" method="post" action="">
                    {% csrf_token %}
                    <input type="hidden" id="delete-comment-id" name="comment_id">
                    <input type="hidden" name="action" value="delete">
                    <input type="hidden" id="delete-comment-type" name="comment_type" value="comment">
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>



<script src="{% static 'unicat/js/resources.js' %}"></script>

{% endblock %}
